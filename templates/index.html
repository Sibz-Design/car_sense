<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Comments Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #FFFFFF;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background-color: #FFFFFF;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
        }

        .header img {
            height: 60px;
            margin-bottom: 10px;
        }

        .header h1 {
            font-family: 'Arial', sans-serif;
            color: #FF0000;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-family: 'Arial', sans-serif;
            color: #333;
            font-size: 1.1rem;
        }

        .theme-selector {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-selector select,
        .theme-selector button {
            padding: 8px 12px;
            border: 1px solid rgba(255, 0, 0, 0.5);
            border-radius: 8px;
            font-family: 'Arial', sans-serif;
            font-size: 0.9rem;
            background: #FFFFFF;
            color: #333;
            cursor: pointer;
            width: 150px;
            text-align: left;
        }

        .theme-selector select:focus,
        .theme-selector button:focus {
            outline: none;
            border-color: #FF0000;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #FFFFFF;
            min-width: 150px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            margin-top: 5px;
        }

        .dropdown-content button {
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            border-bottom: 1px solid rgba(255, 0, 0, 0.1);
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .dropdown-content button:last-child {
            border-bottom: none;
        }

        .dropdown-content button:hover {
            background-color: #FF0000;
            color: #FFFFFF;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #FF0000;
            border-radius: 15px;
            padding: 10px;
        }

        .nav-tab {
            padding: 12px 25px;
            margin: 0 5px;
            background: transparent;
            border: none;
            color: #FFFFFF;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-family: 'Arial', sans-serif;
            font-size: 1rem;
            font-weight: 500;
        }

        .nav-tab:hover,
        .nav-tab.active {
            background: #FFFFFF;
            color: #FF0000;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            background: #FFFFFF;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .control-group label {
            font-family: 'Arial', sans-serif;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .control-group input,
        .control-group select {
            padding: 10px 15px;
            border: 1px solid rgba(255, 0, 0, 0.5);
            border-radius: 8px;
            font-family: 'Arial', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            min-width: 120px;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #FF0000;
        }

        .btn {
            background: #FF0000;
            color: #FFFFFF;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Arial', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            line-height: 1;
            height: 40px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #FFFFFF;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #FF0000;
        }

        .stat-card .number {
            font-family: 'Arial', sans-serif;
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-family: 'Arial', sans-serif;
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: #FFFFFF;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-family: 'Arial', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .description-box {
            display: none;
            background: #FFFFFF;
            border: 2px solid #FF0000;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            font-family: 'Arial', sans-serif;
            font-size: 0.9rem;
            color: #333;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .chart-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            flex-direction: column;
            color: #666;
        }

        .chart-loading i {
            font-size: 1.5rem;
            margin-bottom: 10px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #FF0000;
            color: #FFFFFF;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #FF0000;
        }

        .progress-bar {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-family: 'Arial', sans-serif;
            font-size: 0.9rem;
            color: #333;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .comments-section {
            background: #FFFFFF;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .sentiment-breakdown {
            margin-bottom: 20px;
            font-family: 'Arial', sans-serif;
            color: #333;
        }

        .sentiment-breakdown h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .sentiment-breakdown ul {
            list-style-type: none;
            padding: 0;
        }

        .sentiment-breakdown li {
            margin-bottom: 5px;
        }

        .search-container {
            position: relative;
            width: 300px;
            max-width: 100%;
            margin: 0 auto 15px;
        }

        .search-container input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 1px solid rgba(255, 0, 0, 0.5);
            border-radius: 25px;
            font-family: 'Arial', sans-serif;
            font-size: 1rem;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #FF0000;
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.3s ease;
        }

        .search-icon:hover {
            color: #333;
        }

        .comment-filters {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 0, 0, 0.5);
            background: #FFFFFF;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Arial', sans-serif;
            font-size: 0.9rem;
            color: #FF0000;
        }

        .filter-btn.active {
            background: #FF0000;
            color: #FFFFFF;
            border: 1px solid rgba(255, 0, 0, 0.5);
        }

        .comments-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .comment-item {
            background: #FFFFFF;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #FF0000;
        }

        .comment-item.positive {
            border-left-color: #FF0000;
        }

        .comment-item.negative {
            border-left-color: #333;
        }

        .comment-item.neutral {
            border-left-color: #B0BEC5;
        }

        .comment-author {
            font-family: 'Arial', sans-serif;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .comment-text {
            font-family: 'Arial', sans-serif;
            color: #555;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .comment-meta {
            display: flex;
            justify-content: space-between;
            font-family: 'Arial', sans-serif;
            font-size: 0.8rem;
            color: #888;
        }

        .sentiment-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-family: 'Arial', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            border: 1px solid #000;
        }

        .sentiment-badge.positive {
            background: #FF0000;
            color: #FFFFFF;
        }

        .sentiment-badge.negative {
            background: #333;
            color: #FFFFFF;
        }

        .sentiment-badge.neutral {
            background: #B0BEC5;
            color: #333;
        }

        .videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .video-card {
            background: #FFFFFF;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .video-card:hover {
            transform: translateY(-5px);
        }

        .video-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .video-content {
            padding: 20px;
        }

        .video-title {
            font-family: 'Arial', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            line-height: 1.4;
        }

        .video-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-family: 'Arial', sans-serif;
            font-size: 0.9rem;
            color: #666;
        }

        .video-description {
            font-family: 'Arial', sans-serif;
            color: #777;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .video-sentiment {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        footer {
            background: #FF0000;
            color: #FFFFFF;
            text-align: center;
            padding: 15px;
            border-radius: 15px;
            margin-top: 30px;
            font-family: 'Arial', sans-serif;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: #FFFFFF;
            margin: 10% auto;
            padding: 20px;
            width: 70%;
            max-height: 80%;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-family: 'Arial', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-close {
            background: #FF0000;
            color: #FFFFFF;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Arial', sans-serif;
            font-size: 0.9rem;
            margin-top: 20px;
        }

        .modal-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .ai-analysis-section {
            background: #FFFFFF;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .ai-analysis-section h3 {
            font-family: 'Arial', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .ai-analysis-section ul {
            list-style-type: disc;
            padding-left: 20px;
            font-family: 'Arial', sans-serif;
            color: #555;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .header img {
                height: 50px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                align-items: stretch;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tab {
                flex: 1;
                min-width: 120px;
            }

            .theme-selector {
                position: static;
                margin-bottom: 15px;
                text-align: center;
            }

            .modal-content {
                width: 90%;
            }

            .search-container {
                width: 100%;
            }
        }

        .refresh-time {
            text-align: center;
            font-family: 'Arial', sans-serif;
            color: #333;
            font-size: 0.9rem;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="theme-selector">
                <select id="themeSelect" onchange="changeTheme(this.value)">
                    <option value="plain">Plain White</option>
                    <option value="silver">Silver Smart Fortwo</option>
                    <option value="yellow">Yellow Smart Fortwo</option>
                    <option value="black">Black Smart Fortwo</option>
                </select>
                <div class="dropdown">
                    <button class="btn" style="font-size: 0.9rem;"><i class="fas fa-download"></i> Export</button>
                    <div class="dropdown-content">
                        <button onclick="exportData('DOCX')">Export as Word</button>
                    </div>
                </div>
            </div>
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYsSip2yFxAGLYCwbj3ZqpM_VS4dTL5lXyIA&s" alt="Cars.co.za Logo">
            <h1><i class="fab fa-youtube"></i> YouTube Comments Analytics</h1>
            <p>Comprehensive analysis of YouTube channel comments and engagement</p>
            <div class="refresh-time" id="lastRefresh"></div>
            <button class="btn" style="position: absolute; top: 20px; right: 20px; padding: 8px 12px; font-size: 0.9rem;" onclick="showHelp()">
                <i class="fas fa-question-circle"></i> Help
            </button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-chart-line"></i> Dashboard
            </button>
            <button class="nav-tab" data-tab="sentiment">
                <i class="fas fa-heart"></i> Sentiment Analysis
            </button>
            <button class="nav-tab" data-tab="videos">
                <i class="fas fa-video"></i> Videos
            </button>
            <button class="nav-tab" data-tab="ai-analysis">
                <i class="fas fa-brain"></i> AI Analysis
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="controls">
                <div class="control-group">
                    <label for="maxVideos">Max Videos</label>
                    <input type="number" id="maxVideos" min="1" max="20" value="10">
                </div>
                <div class="control-group">
                    <label for="maxComments">Comments per Video</label>
                    <input type="number" id="maxComments" min="10" max="100" value="50">
                </div>
                <button class="btn" id="loadBtn">
                    <i class="fas fa-sync-alt"></i> Load Data
                </button>
            </div>
            <div class="progress-bar" id="dashboardProgress"></div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-comments"></i></div>
                    <div class="number" id="totalComments">-</div>
                    <div class="label">Total Comments</div>
                </div>
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-video"></i></div>
                    <div class="number" id="totalVideos">-</div>
                    <div class="label">Videos Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-thumbs-up"></i></div>
                    <div class="number" id="totalLikes">-</div>
                    <div class="label">Total Likes</div>
                </div>
                <div class="stat-card">
                    <div class="icon"><i class="fas fa-heart"></i></div>
                    <div class="number" id="avgLikes">-</div>
                    <div class="label">Avg. Likes/Comment</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Comments by Video</div>
                    <button class="btn" onclick="toggleDescription('pie-description')">Show Description</button>
                    <div id="pieChart" class="chart-loading">
                        <i class="fas fa-spinner"></i>
                        <span>Click "Load Data" to view chart</span>
                    </div>
                    <div class="description-box" id="pie-description">
                        This pie chart illustrates the distribution of comments across the top 10 Cars.co.za videos from the past 30 days, based on comment count. Each slice represents a video, sized proportionally to its comment volume. Use this to identify high-engagement videos.
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Sentiment Distribution</div>
                    <button class="btn" onclick="toggleDescription('sentiment-description')">Show Description</button>
                    <div id="sentimentChart" class="chart-loading">
                        <i class="fas fa-spinner"></i>
                        <span>Click "Load Data" to view chart</span>
                    </div>
                    <div class="description-box" id="sentiment-description">
                        This pie chart shows the proportion of positive, negative, and neutral comments on Cars.co.za videos. Each slice reflects a sentiment category, sized by comment count. Use this to gauge overall audience sentiment.
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Comments Over Time</div>
                    <button class="btn" onclick="toggleDescription('bar-description')">Show Description</button>
                    <div id="barChart" class="chart-loading">
                        <i class="fas fa-spinner"></i>
                        <span>Click "Load Data" to view chart</span>
                    </div>
                    <div class="description-box" id="bar-description">
                        This bar chart displays daily comment counts for Cars.co.za videos over the past 30 days. Each bar represents a day, with height indicating comment volume. Use this to track engagement trends.
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Sentiment Trend (14 Days)</div>
                    <button class="btn" onclick="toggleDescription('trend-description')">Show Description</button>
                    <div id="trendChart" class="chart-loading">
                        <i class="fas fa-spinner"></i>
                        <span>Click "Load Data" to view chart</span>
                    </div>
                    <div class="description-box" id="trend-description">
                        This line chart tracks daily sentiment (positive, negative, neutral) of comments on Cars.co.za videos over the past 14 days. Each line shows sentiment trends over time. Use this to monitor shifts in audience feedback.
                    </div>
                </div>
            </div>
        </div>

        <!-- Sentiment Analysis Tab -->
        <div class="tab-content" id="sentiment">
            <div class="controls">
                <div class="control-group">
                    <label for="sentimentVideos">Max Videos</label>
                    <input type="number" id="sentimentVideos" min="1" max="10" value="5">
                </div>
                <div class="control-group">
                    <label for="sentimentComments">Comments per Video</label>
                    <input type="number" id="sentimentComments" min="10" max="50" value="20">
                </div>
                <button class="btn" id="sentimentBtn">
                    <i class="fas fa-heart"></i> Analyze Sentiment
                </button>
            </div>
            <div class="progress-bar" id="sentimentProgress"></div>
            <div class="comments-section">
                <div class="chart-title">Live Comments with Sentiment</div>
                <div class="sentiment-breakdown" id="sentimentBreakdown"></div>
                <div class="search-container">
                    <input type="text" id="commentSearch" placeholder="Search by author name...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="comment-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="positive">Positive</button>
                    <button class="filter-btn" data-filter="negative">Negative</button>
                    <button class="filter-btn" data-filter="neutral">Neutral</button>
                </div>
                <div class="comments-list" id="commentsList">
                    <div class="loading">
                        <i class="fas fa-comments"></i>
                        <span>Click "Analyze Sentiment" to view comments</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Videos Tab -->
        <div class="tab-content" id="videos">
            <div class="controls">
                <button class="btn" id="videosBtn">
                    <i class="fas fa-video"></i> Load Videos
                </button>
            </div>
            <div class="progress-bar" id="videosProgress"></div>
            <div class="videos-grid" id="videosGrid">
                <div class="loading">
                    <i class="fas fa-video"></i>
                    <span>Click "Load Videos" to view video data</span>
                </div>
            </div>
        </div>

        <!-- AI Analysis Tab -->
        <div class="tab-content" id="ai-analysis">
            <div class="controls">
                <div class="control-group">
                    <label for="videoUrl">YouTube Video URL</label>
                    <input type="text" id="videoUrl" placeholder="e.g., https://www.youtube.com/watch?v=VIDEO_ID">
                </div>
                <div class="control-group">
                    <label for="sentimentType">Sentiment to Analyze</label>
                    <select id="sentimentType">
                        <option value="negative">Negative</option>
                        <option value="positive">Positive</option>
                    </select>
                </div>
                <button class="btn" id="aiAnalysisBtn">
                    <i class="fas fa-brain"></i> Generate AI Analysis
                </button>
            </div>
            <div class="progress-bar" id="aiAnalysisProgress"></div>
            <div class="ai-analysis-section">
                <div class="chart-title">AI-Powered Sentiment Analysis</div>
                <div id="aiAnalysisContent">
                    <div class="loading">
                        <i class="fas fa-brain"></i>
                        <span>Enter a YouTube URL and click "Generate AI Analysis" to view results</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sentiment Authors Modal -->
        <div class="modal" id="sentimentModal">
            <div class="modal-content">
                <div class="modal-header">Authors for <span id="modalSentiment"></span> Sentiment</div>
                <ul id="modalAuthors" class="ai-analysis-section"></ul>
                <button class="modal-close">Close</button>
            </div>
        </div>

        <footer>
            <p>Â© 2025 YouTube Comments Analytics Dashboard. All rights reserved.</p>
        </footer>
    </div>

    <script>
        let currentFilter = 'all';
        let allComments = [];
        let videosData = [];

        // Theme switching functionality
        function changeTheme(theme) {
            const body = document.body;
            if (theme === 'plain') {
                body.style.background = '#FFFFFF';
                body.style.backgroundImage = 'none';
            } else {
                const images = {
                    silver: 'https://img-ik.cars.co.za/news-site-za/images/2025/05/m2-cs-2025-2.jpg?tr=w-800',
                    yellow: 'https://elitetraveler.com/wp-content/uploads/sites/8/2022/04/01_Lotus_Eletre_Yellow_Studio_F34-scaled.jpg',
                    black: 'https://wallpapers.com/images/hd/two-lamborghinis-orange-and-black-2xvadibmxz0jcmfw.webp'
                };
                body.style.backgroundImage = `url('${images[theme]}')`;
                body.style.backgroundSize = 'cover';
                body.style.backgroundPosition = 'center';
                body.style.backgroundAttachment = 'fixed';
            }
            localStorage.setItem('theme', theme);
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'plain';
            document.getElementById('themeSelect').value = savedTheme;
            changeTheme(savedTheme);
        }

        // Toggle description visibility
        function toggleDescription(id) {
            const desc = document.getElementById(id);
            desc.style.display = desc.style.display === 'block' ? 'none' : 'block';
        }

        // Tab switching functionality
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'sentiment') {
                displayComments(currentFilter);
            } else {
                document.getElementById('commentSearch').value = '';
            }
            hideAllProgressBars();
        }

        // Hide all progress bars
        function hideAllProgressBars() {
            document.querySelectorAll('.progress-bar').forEach(bar => bar.classList.remove('active'));
        }

        // Update progress bar
        function updateProgressBar(id, current, total, message) {
            const progressBar = document.getElementById(id);
            progressBar.classList.add('active');
            progressBar.textContent = `${message}: ${current} of ${total} (${Math.round((current / total) * 100)}%)`;
            if (current >= total) {
                setTimeout(() => progressBar.classList.remove('active'), 2000);
            }
        }

        // Update statistics cards
        function updateStats(summary) {
            console.log('Updating stats with:', summary);
            document.getElementById('totalComments').textContent = summary.total_comments ? summary.total_comments.toLocaleString() : '0';
            document.getElementById('totalVideos').textContent = summary.total_videos || '0';
            document.getElementById('totalLikes').textContent = summary.total_likes ? summary.total_likes.toLocaleString() : '0';
            document.getElementById('avgLikes').textContent = summary.avg_likes_per_comment || '0';
        }

        // Create all charts
        function createCharts(data) {
            console.log('Creating charts with data:', data);
            ['pieChart', 'sentimentChart', 'barChart', 'trendChart'].forEach(chartId => {
                const chart = document.getElementById(chartId);
                chart.innerHTML = '';
                chart.classList.remove('chart-loading');
            });

            // Pie Chart: Comments by Video
            if (data.pie_chart && Array.isArray(data.pie_chart.labels) && Array.isArray(data.pie_chart.values) && data.pie_chart.labels.length > 0) {
                console.log('Rendering Pie Chart:', data.pie_chart);
                const pieData = [{
                    values: data.pie_chart.values,
                    labels: data.pie_chart.labels,
                    type: 'pie',
                    hole: 0.4,
                    marker: {
                        colors: data.pie_chart.colors || ['#FF0000', '#FF4D4D', '#FF6666', '#FF8080', '#FF9999', '#FFB3B3', '#FFCCCC', '#FFE6E6', '#FFF2F2', '#FFFFFF']
                    },
                    textinfo: 'label+percent',
                    textposition: 'outside'
                }];
                
                const pieLayout = {
                    showlegend: true,
                    height: 400,
                    margin: { t: 20, b: 20, l: 20, r: 20 },
                    paper_bgcolor: '#FFFFFF',
                    font: { family: 'Arial, sans-serif', color: '#333' }
                };
                
                try {
                    Plotly.newPlot('pieChart', pieData, pieLayout, {responsive: true});
                } catch (error) {
                    console.error('Error rendering Pie Chart:', error);
                    document.getElementById('pieChart').innerHTML = '<div class="error">Failed to render chart: Invalid data</div>';
                }
            } else {
                console.warn('Pie Chart data invalid or empty:', data.pie_chart);
                document.getElementById('pieChart').innerHTML = '<div class="error">No data available for Comments by Video</div>';
            }

            // Sentiment Distribution Chart
            if (data.summary && data.summary.sentiment_counts) {
                console.log('Rendering Sentiment Chart:', data.summary.sentiment_counts);
                const sentimentData = data.summary.sentiment_counts;
                const sentimentPieData = [{
                    values: [sentimentData.positive || 0, sentimentData.negative || 0, sentimentData.neutral || 0],
                    labels: ['Positive', 'Negative', 'Neutral'],
                    type: 'pie',
                    hole: 0.4,
                    marker: {
                        colors: ['#FF0000', '#333', '#B0BEC5']
                    },
                    textinfo: 'label+percent+value',
                    textposition: 'outside'
                }];
                
                const sentimentLayout = {
                    showlegend: true,
                    height: 400,
                    margin: { t: 20, b: 20, l: 20, r: 20 },
                    paper_bgcolor: '#FFFFFF',
                    font: { family: 'Arial, sans-serif', color: '#333' }
                };
                
                try {
                    Plotly.newPlot('sentimentChart', sentimentPieData, sentimentLayout, {responsive: true});
                } catch (error) {
                    console.error('Error rendering Sentiment Chart:', error);
                    document.getElementById('sentimentChart').innerHTML = '<div class="error">Failed to render chart: Invalid data</div>';
                }
            } else {
                console.warn('Sentiment Chart data invalid or empty:', data.summary);
                document.getElementById('sentimentChart').innerHTML = '<div class="error">No data available for Sentiment Distribution</div>';
            }

            // Bar Chart: Comments Over Time
            if (data.bar_chart && Array.isArray(data.bar_chart.labels) && Array.isArray(data.bar_chart.values) && data.bar_chart.labels.length > 0) {
                console.log('Rendering Bar Chart:', data.bar_chart);
                const barData = [{
                    x: data.bar_chart.labels,
                    y: data.bar_chart.values,
                    type: 'bar',
                    marker: {
                        color: '#FF0000'
                    }
                }];
                
                const barLayout = {
                    title: '',
                    xaxis: { title: 'Date', tickangle: 45 },
                    yaxis: { title: 'Comments' },
                    height: 400,
                    margin: { t: 20, b: 80, l: 50, r: 20 },
                    paper_bgcolor: '#FFFFFF',
                    font: { family: 'Arial, sans-serif', color: '#333' }
                };
                
                try {
                    Plotly.newPlot('barChart', barData, barLayout, {responsive: true});
                } catch (error) {
                    console.error('Error rendering Bar Chart:', error);
                    document.getElementById('barChart').innerHTML = '<div class="error">Failed to render chart: Invalid data</div>';
                }
            } else {
                console.warn('Bar Chart data invalid or empty:', data.bar_chart);
                document.getElementById('barChart').innerHTML = '<div class="error">No data available for Comments Over Time</div>';
            }

            // Trend Chart: Sentiment Trend
            if (data.sentiment_trend && Array.isArray(data.sentiment_trend.dates) && data.sentiment_trend.dates.length > 0) {
                console.log('Rendering Trend Chart:', data.sentiment_trend);
                const trendData = [
                    {
                        x: data.sentiment_trend.dates,
                        y: data.sentiment_trend.positive || new Array(data.sentiment_trend.dates.length).fill(0),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Positive',
                        line: { color: '#FF0000' }
                    },
                    {
                        x: data.sentiment_trend.dates,
                        y: data.sentiment_trend.negative || new Array(data.sentiment_trend.dates.length).fill(0),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Negative',
                        line: { color: '#333' }
                    },
                    {
                        x: data.sentiment_trend.dates,
                        y: data.sentiment_trend.neutral || new Array(data.sentiment_trend.dates.length).fill(0),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Neutral',
                        line: { color: '#B0BEC5', dash: 'dash' }
                    }
                ];
                
                const trendLayout = {
                    xaxis: { title: 'Date', tickangle: 45 },
                    yaxis: { title: 'Comments' },
                    height: 400,
                    margin: { t: 20, b: 80, l: 50, r: 20 },
                    showlegend: true,
                    paper_bgcolor: '#FFFFFF',
                    font: { family: 'Arial, sans-serif', color: '#333' }
                };
                
                try {
                    Plotly.newPlot('trendChart', trendData, trendLayout, {responsive: true});
                } catch (error) {
                    console.error('Error rendering Trend Chart:', error);
                    document.getElementById('trendChart').innerHTML = '<div class="error">Failed to render chart: Invalid data</div>';
                }
            } else {
                console.warn('Trend Chart data invalid or empty:', data.sentiment_trend);
                document.getElementById('trendChart').innerHTML = '<div class="error">No data available for Sentiment Trend</div>';
            }
        }

        // Dashboard data loading
        async function loadDashboardData() {
            const loadBtn = document.getElementById('loadBtn');
            const maxVideos = parseInt(document.getElementById('maxVideos').value) || 10;
            const maxComments = parseInt(document.getElementById('maxComments').value) || 50;
            
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            updateProgressBar('dashboardProgress', 0, maxVideos, 'Fetching videos');
            
            try {
                console.log('Fetching dashboard data with:', { maxVideos, maxComments });
                const response = await fetch(`/api/chart-data?max_videos=${maxVideos}&max_comments=${maxComments}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Received dashboard data:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Validate data structure
                if (!data.summary || !data.pie_chart || !data.bar_chart || !data.sentiment_trend) {
                    throw new Error('Incomplete data received from API');
                }
                
                // Simulate progress for each video
                let currentVideo = 0;
                const videos = data.videos_with_comments || [];
                videos.forEach((_, index) => {
                    setTimeout(() => {
                        currentVideo++;
                        updateProgressBar('dashboardProgress', currentVideo, maxVideos, 'Processing videos');
                    }, index * 100);
                });
                
                updateStats(data.summary);
                updateProgressBar('dashboardProgress', maxVideos, maxVideos, 'Rendering charts');
                createCharts(data);
                updateRefreshTime();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data: ' + error.message);
                ['pieChart', 'sentimentChart', 'barChart', 'trendChart'].forEach(chartId => {
                    const chart = document.getElementById(chartId);
                    chart.innerHTML = '<div class="error">Failed to load chart: ' + error.message + '</div>';
                    chart.classList.remove('chart-loading');
                });
            } finally {
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Load Data';
            }
        }

        // Load sentiment analysis data
        async function loadSentimentData() {
            const sentimentBtn = document.getElementById('sentimentBtn');
            const maxVideos = parseInt(document.getElementById('sentimentVideos').value) || 5;
            const maxComments = parseInt(document.getElementById('sentimentComments').value) || 20;
            
            sentimentBtn.disabled = true;
            sentimentBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            updateProgressBar('sentimentProgress', 0, maxVideos, 'Processing videos');
            
            try {
                const response = await fetch(`/api/sentiment-data?max_videos=${maxVideos}&max_comments=${maxComments}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                videosData = data.videos_with_comments.slice(0, maxVideos);
                allComments = {
                    positive: [],
                    negative: [],
                    neutral: []
                };
                
                let currentVideo = 0;
                videosData.forEach(video => {
                    const comments = video.comments.slice(0, maxComments);
                    comments.forEach(comment => {
                        if (comment.sentiment === 'positive') allComments.positive.push({ ...comment, videoId: video.videoId });
                        else if (comment.sentiment === 'negative') allComments.negative.push({ ...comment, videoId: video.videoId });
                        else if (comment.sentiment === 'neutral') allComments.neutral.push({ ...comment, videoId: video.videoId });
                    });
                    currentVideo++;
                    updateProgressBar('sentimentProgress', currentVideo, maxVideos, 'Processing videos');
                });
                
                displayComments(currentFilter);
                displaySentimentBreakdown();
                
            } catch (error) {
                console.error('Error loading sentiment data:', error);
                showError('Failed to load sentiment data: ' + error.message);
            } finally {
                sentimentBtn.disabled = false;
                sentimentBtn.innerHTML = '<i class="fas fa-heart"></i> Analyze Sentiment';
            }
        }

        // Display sentiment breakdown
        function displaySentimentBreakdown() {
            const breakdownDiv = document.getElementById('sentimentBreakdown');
            if (!videosData || videosData.length === 0) {
                breakdownDiv.innerHTML = '';
                return;
            }

            const breakdownHTML = videosData.map(video => {
                const sentimentCounts = { positive: 0, negative: 0, neutral: 0 };
                video.comments.forEach(comment => {
                    if (comment.sentiment === 'positive') sentimentCounts.positive++;
                    else if (comment.sentiment === 'negative') sentimentCounts.negative++;
                    else if (comment.sentiment === 'neutral') sentimentCounts.neutral++;
                });
                return `
                    <h3>${video.title}</h3>
                    <ul>
                        <li>Positive: ${sentimentCounts.positive}</li>
                        <li>Negative: ${sentimentCounts.negative}</li>
                        <li>Neutral: ${sentimentCounts.neutral}</li>
                        <li>Total: ${video.comments.length}</li>
                    </ul>
                `;
            }).join('');
            
            breakdownDiv.innerHTML = breakdownHTML;
        }

        // Display comments based on filter
        function displayComments(filter) {
            const commentsList = document.getElementById('commentsList');
            if (!videosData || videosData.length === 0) {
                commentsList.innerHTML = '<div class="loading"><i class="fas fa-comments"></i><span>Click "Analyze Sentiment" to view comments</span></div>';
                return;
            }

            let commentsToShow = [];
            if (filter === 'all') {
                commentsToShow = [
                    ...allComments.positive.map(c => ({ ...c, sentiment: 'positive', videoId: c.videoId })),
                    ...allComments.negative.map(c => ({ ...c, sentiment: 'negative', videoId: c.videoId })),
                    ...allComments.neutral.map(c => ({ ...c, sentiment: 'neutral', videoId: c.videoId }))
                ];
            } else {
                commentsToShow = allComments[filter]
                    .map(c => ({ ...c, sentiment: filter, videoId: c.videoId })) || [];
            }

            commentsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (commentsToShow.length === 0) {
                commentsList.innerHTML = '<div class="loading"><i class="fas fa-comments"></i><span>No comments found for this filter</span></div>';
                return;
            }
            
            const groupedComments = {};
            commentsToShow.forEach(comment => {
                if (!groupedComments[comment.videoId]) {
                    groupedComments[comment.videoId] = [];
                }
                groupedComments[comment.videoId].push(comment);
            });
            
            const commentsHTML = Object.entries(groupedComments).map(([videoId, comments]) => {
                const video = videosData.find(v => v.videoId === videoId);
                const videoTitle = video ? video.title : 'Unknown Video';
                return `
                    <div class="chart-title">${videoTitle}</div>
                    ${comments.map(comment => `
                        <div class="comment-item ${comment.sentiment}">
                            <div class="comment-author">${comment.author}</div>
                            <div class="comment-text">${comment.comment} <strong>(${comment.sentiment.charAt(0).toUpperCase() + comment.sentiment.slice(1)})</strong></div>
                            <div class="comment-meta">
                                <span><i class="fas fa-thumbs-up"></i> ${comment.likeCount}</span>
                                <span class="sentiment-badge ${comment.sentiment}">${comment.sentiment}</span>
                                <span>${new Date(comment.date).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `).join('')}
                `;
            }).join('');
            
            commentsList.innerHTML = commentsHTML;
        }

        // Filter comments
        function filterComments(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            currentFilter = filter;
            displayComments(filter);
        }

        // Search comments by author name
        function searchComments(query) {
            const commentsList = document.getElementById('commentsList');
            if (!videosData || videosData.length === 0) {
                commentsList.innerHTML = '<div class="loading"><i class="fas fa-comments"></i><span>Click "Analyze Sentiment" to view comments</span></div>';
                return;
            }

            const searchTerm = query.trim().toLowerCase();
            let commentsToShow = [
                ...allComments.positive.map(c => ({ ...c, sentiment: 'positive', videoId: c.videoId })),
                ...allComments.negative.map(c => ({ ...c, sentiment: 'negative', videoId: c.videoId })),
                ...allComments.neutral.map(c => ({ ...c, sentiment: 'neutral', videoId: c.videoId }))
            ];
            
            if (searchTerm) {
                commentsToShow = commentsToShow.filter(c => c.author.toLowerCase() === searchTerm);
                if (commentsToShow.length === 0) {
                    commentsList.innerHTML = '<div class="loading"><i class="fas fa-comments"></i><span>No comment found</span></div>';
                    return;
                }
            }
            
            if (currentFilter !== 'all') {
                commentsToShow = commentsToShow.filter(c => c.sentiment === currentFilter);
            }

            commentsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (commentsToShow.length === 0) {
                commentsList.innerHTML = '<div class="loading"><i class="fas fa-comments"></i><span>No comments found for this filter</span></div>';
                return;
            }
            
            const groupedComments = {};
            commentsToShow.forEach(comment => {
                if (!groupedComments[comment.videoId]) {
                    groupedComments[comment.videoId] = [];
                }
                groupedComments[comment.videoId].push(comment);
            });
            
            const commentsHTML = Object.entries(groupedComments).map(([videoId, comments]) => {
                const video = videosData.find(v => v.videoId === videoId);
                const videoTitle = video ? video.title : 'Unknown Video';
                return `
                    <div class="chart-title">${videoTitle}</div>
                    ${comments.map(comment => `
                        <div class="comment-item ${comment.sentiment}">
                            <div class="comment-author">${comment.author}</div>
                            <div class="comment-text">${comment.comment} <strong>(${comment.sentiment.charAt(0).toUpperCase() + comment.sentiment.slice(1)})</strong></div>
                            <div class="comment-meta">
                                <span><i class="fas fa-thumbs-up"></i> ${comment.likeCount}</span>
                                <span class="sentiment-badge ${comment.sentiment}">${comment.sentiment}</span>
                                <span>${new Date(comment.date).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `).join('')}
                `;
            }).join('');
            
            commentsList.innerHTML = commentsHTML;
        }

        // Load videos data
        async function loadVideosData() {
            const videosBtn = document.getElementById('videosBtn');
            const videosGrid = document.getElementById('videosGrid');
            const maxVideos = 10;
            const maxComments = 30;
            
            videosBtn.disabled = true;
            videosBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            updateProgressBar('videosProgress', 0, maxVideos, 'Processing videos');
            
            try {
                const response = await fetch(`/api/sentiment-data?max_videos=${maxVideos}&max_comments=${maxComments}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                videosData = data.videos_with_comments.slice(0, maxVideos);
                let currentVideo = 0;
                videosData.forEach((_, index) => {
                    setTimeout(() => {
                        currentVideo++;
                        updateProgressBar('videosProgress', currentVideo, maxVideos, 'Processing videos');
                    }, index * 100);
                });
                
                displayVideos(videosData);
                
            } catch (error) {
                console.error('Error loading videos data:', error);
                showError('Failed to load videos data: ' + error.message);
            } finally {
                videosBtn.disabled = false;
                videosBtn.innerHTML = '<i class="fas fa-video"></i> Load Videos';
            }
        }

        // Display videos with HD thumbnails and accurate comment counts
        function displayVideos(videos) {
            const videosGrid = document.getElementById('videosGrid');
            
            if (!videos || videos.length === 0) {
                videosGrid.innerHTML = '<div class="loading"><i class="fas fa-video"></i><span>No videos found</span></div>';
                return;
            }
            
            const videosHTML = videos.map(video => {
                const sentimentCounts = { positive: 0, negative: 0, neutral: 0 };
                video.comments.forEach(comment => {
                    if (comment.sentiment === 'positive') sentimentCounts.positive++;
                    else if (comment.sentiment === 'negative') sentimentCounts.negative++;
                    else if (comment.sentiment === 'neutral') sentimentCounts.neutral++;
                });
                const commentCount = video.comments.length;
                const totalCommentCount = video.commentCount || commentCount;
                const thumbnailUrl = video.thumbnail ? 
                    video.thumbnail.replace(/\/[^/]+\.jpg$/, '/maxresdefault.jpg') : 
                    `https://i.ytimg.com/vi/${video.videoId}/maxresdefault.jpg`;
                
                return `
                    <div class="video-card">
                        ${video.thumbnail ? `<img src="${thumbnailUrl}" alt="${video.title}" class="video-thumbnail" onerror="this.src='${thumbnailUrl.replace('maxresdefault.jpg', 'hqdefault.jpg')}';">` : ''}
                        <div class="video-content">
                            <div class="video-title">${video.title}</div>
                            <div class="video-stats">
                                <span><i class="fas fa-comments"></i> ${commentCount} comments ${commentCount < totalCommentCount ? `(of ${totalCommentCount})` : ''}</span>
                                <span><i class="fas fa-calendar"></i> ${new Date(video.publishedAt).toLocaleDateString()}</span>
                            </div>
                            <div class="video-description">${video.description}</div>
                            <div class="video-sentiment">
                                <span class="sentiment-badge positive" data-video-id="${video.videoId}" data-sentiment="positive">${sentimentCounts.positive}</span>
                                <span class="sentiment-badge negative" data-video-id="${video.videoId}" data-sentiment="negative">${sentimentCounts.negative}</span>
                                <span class="sentiment-badge neutral" data-video-id="${video.videoId}" data-sentiment="neutral">${sentimentCounts.neutral}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            videosGrid.innerHTML = videosHTML;

            document.querySelectorAll('.sentiment-badge').forEach(badge => {
                badge.addEventListener('click', async () => {
                    const videoId = badge.dataset.videoId;
                    const sentiment = badge.dataset.sentiment;
                    try {
                        const response = await fetch(`/api/video-details/${videoId}?max_comments=100`);
                        const data = await response.json();
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        const authors = data.comments
                            .filter(c => c.sentiment === sentiment)
                            .map(c => c.author);
                        const modal = document.getElementById('sentimentModal');
                        document.getElementById('modalSentiment').textContent = sentiment.charAt(0).toUpperCase() + sentiment.slice(1);
                        const authorsList = document.getElementById('modalAuthors');
                        authorsList.innerHTML = authors.length ? authors.map(a => `<li>${a}</li>`).join('') : '<li>No authors found</li>';
                        modal.style.display = 'block';
                    } catch (error) {
                        console.error('Error fetching authors:', error);
                        showError('Failed to load authors: ' + error.message);
                    }
                });
            });
        }

        // Close modal
        function closeModal() {
            document.getElementById('sentimentModal').style.display = 'none';
        }

        // AI Analysis
        async function loadAIAnalysis() {
            const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
            const videoUrl = document.getElementById('videoUrl').value.trim();
            const sentimentType = document.getElementById('sentimentType').value;
            
            if (!videoUrl) {
                showError('Please enter a YouTube video URL');
                return;
            }

            const urlPattern = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = videoUrl.match(urlPattern);
            if (!match) {
                showError('Invalid YouTube URL format');
                return;
            }
            const videoId = match[1];
            const apiUrl = `/api/ai-analysis?video_url=${encodeURIComponent(videoUrl)}&sentiment_type=${sentimentType}&max_comments=50`;

            aiAnalysisBtn.disabled = true;
            aiAnalysisBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            updateProgressBar('aiAnalysisProgress', 0, 1, 'Processing video');
            
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                updateProgressBar('aiAnalysisProgress', 1, 1, 'Processing video');
                
                const content = document.getElementById('aiAnalysisContent');
                const videoTitle = data.videoTitle || `Video ID: ${videoId}`;
                let html = `
                    <h3>Analysis for: ${videoTitle}</h3>
                    <h3>Overview</h3>
                    <p>${data.overview}</p>
                    <h3>Top ${sentimentType.charAt(0).toUpperCase() + sentimentType.slice(1)} Comments</h3>
                    <ul>
                        ${data.comments_by_video[0]?.comments.map(c => `<li><strong>${c.author}</strong>: ${c.comment} (Likes: ${c.likeCount})</li>`).join('') || '<li>No comments found</li>'}
                    </ul>
                    <h3>Key Themes</h3>
                    <ul>${data.themes.map(t => `<li>${t}</li>`).join('') || '<li>No themes identified</li>'}</ul>
                    <h3>Recommendations for Improvement</h3>
                    <ul>${data.recommendations.map(r => `<li>${r}</li>`).join('') || '<li>No recommendations available</li>'}</ul>
                `;
                
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading AI analysis:', error);
                showError('Failed to load AI analysis: ' + error.message);
            } finally {
                aiAnalysisBtn.disabled = false;
                aiAnalysisBtn.innerHTML = '<i class="fas fa-brain"></i> Generate AI Analysis';
            }
        }

        // Export data
        async function exportData(format) {
            try {
                const response = await fetch(`/api/export-data?format=${format}`);
                if (!response.ok) {
                    throw new Error('Failed to generate export');
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics_report_${new Date().toISOString().replace(/[:.]/g, '')}.${format.toLowerCase()}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting data:', error);
                showError('Failed to export data: ' + error.message);
            }
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(errorDiv, activeTab.firstChild);
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function updateRefreshTime() {
            const now = new Date();
            document.getElementById('lastRefresh').textContent = 
                `Last updated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
        }

        let autoRefreshInterval;

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab.id === 'dashboard') {
                    loadDashboardData();
                }
            }, 300000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            updateRefreshTime();
            startAutoRefresh();
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            document.getElementById('loadBtn').addEventListener('click', loadDashboardData);
            document.getElementById('sentimentBtn').addEventListener('click', loadSentimentData);
            document.getElementById('videosBtn').addEventListener('click', loadVideosData);
            document.getElementById('aiAnalysisBtn').addEventListener('click', loadAIAnalysis);
            document.querySelector('.modal-close').addEventListener('click', closeModal);
            document.getElementById('commentSearch').addEventListener('input', () => searchComments(document.getElementById('commentSearch').value));
            document.querySelector('.search-icon').addEventListener('click', () => searchComments(document.getElementById('commentSearch').value));
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => filterComments(btn.dataset.filter));
            });
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            switchTab('dashboard');
                            break;
                        case '2':
                            e.preventDefault();
                            switchTab('sentiment');
                            break;
                        case '3':
                            e.preventDefault();
                            switchTab('videos');
                            break;
                        case '4':
                            e.preventDefault();
                            switchTab('ai-analysis');
                            break;
                        case 'r':
                            e.preventDefault();
                            const activeTab = document.querySelector('.tab-content.active');
                            if (activeTab.id === 'dashboard') {
                                loadDashboardData();
                            } else if (activeTab.id === 'sentiment') {
                                loadSentimentData();
                            } else if (activeTab.id === 'videos') {
                                loadVideosData();
                            } else if (activeTab.id === 'ai-analysis') {
                                loadAIAnalysis();
                            }
                            break;
                    }
                }
            });
            window.switchTab = switchTab;
            addTooltips();
        });

        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        window.addEventListener('resize', function() {
            ['pieChart', 'sentimentChart', 'barChart', 'trendChart'].forEach(chartId => {
                const element = document.getElementById(chartId);
                if (element && element.data) {
                    Plotly.Plots.resize(element);
                }
            });
        });

        function addTooltips() {
            document.querySelectorAll('.stat-card').forEach(card => {
                const label = card.querySelector('.label').textContent;
                const number = card.querySelector('.number').textContent;
                card.title = `${label}: ${number}`;
            });
        }

        function showHelp() {
            const helpText = `
                Keyboard Shortcuts:
                â¢ Ctrl/Cmd + 1, 2, 3, 4: Switch tabs (Dashboard, Sentiment, Videos, AI Analysis)
                â¢ Ctrl/Cmd + R: Refresh current tab
                â¢ Alt + D: Load dashboard data
                â¢ Alt + S: Load sentiment data
                â¢ Alt + V: Load videos data
                â¢ Alt + A: Generate AI analysis
                
                Features:
                â¢ Theme selector: Choose between plain white or car-themed backgrounds
                â¢ Export: Download data as Word from the top-left dropdown
                â¢ Auto-refresh every 5 minutes for Dashboard tab
                â¢ Real-time sentiment analysis with clickable sentiment totals
                â¢ Interactive charts with Plotly
                â¢ Comment filtering by sentiment and author name search
                â¢ Comments sorted by most recent by default
                â¢ AI-powered sentiment analysis for specific videos by URL with accurate titles
                â¢ Accurate comment counts in Videos tab, showing loaded comments and total if applicable
                â¢ Sentiment Analysis displays exactly the selected number of videos and comments
                â¢ Progress bars show real-time loading status
                â¢ Sentiment breakdown per video in Sentiment Analysis tab
            `;
            alert(helpText);
        }
    </script>
</body>
</html>